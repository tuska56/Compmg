<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>NUNCIO CORE</title>
<style>
body { background:#111; color:#0f0; font-family:monospace; padding:20px; }
.block { margin-top:20px; padding:10px; border:1px solid #333; }
input { width:80px; }
</style>
</head>
<body>

<h2>NUNCIO CORE ENGINE</h2>

<input type="file" id="fileInput">
<button id="saveBtn" disabled>Guardar</button>

<div id="editor"></div>

<script>

const NuncioEngine = {
MARKER:[91,115,111,117,114,99,101,58],

decode(buffer){
const u=new Uint8Array(buffer);
const v=new DataView(buffer);
let blocks=[];
let sources=[];

for(let i=0;i<u.length-15;i++){
let ok=true;
for(let j=0;j<this.MARKER.length;j++){
if(u[i+j]!==this.MARKER[j]){ok=false;break;}
}
if(ok){
let id="";
let k=i+8;
while(u[k]!==93 && k<i+15){
id+=String.fromCharCode(u[k]);
k++;
}
blocks.push({id:parseInt(id),start:i,dataStart:k+1});
}
}

blocks.forEach((b,idx)=>{
const end=blocks[idx+1]?blocks[idx+1].start:u.length;
let s={id:b.id};

if(b.id<13){
s.points=[];
let count=Math.floor((end-b.dataStart)/48);
for(let p=0;p<count;p++){
let off=b.dataStart+(p*48);
s.points.push({
tx:v.getFloat64(off,true),
ty:v.getFloat64(off+8,true),
tz:v.getFloat64(off+16,true),
rx:v.getFloat64(off+24,true),
ry:v.getFloat64(off+32,true),
rz:v.getFloat64(off+40,true)
});
}
}
sources.push(s);
});

return {sources};
},

encode(original,data){
const buf=new Uint8Array(original);
const v=new DataView(buf.buffer);
const blocks=this.getStructure(buf);

data.sources.forEach(s=>{
const ref=blocks.find(b=>b.id===s.id);
if(!ref)return;

s.points.forEach((pt,i)=>{
let off=ref.dataStart+(i*48);
v.setFloat64(off,pt.tx,true);
v.setFloat64(off+8,pt.ty,true);
v.setFloat64(off+16,pt.tz,true);
v.setFloat64(off+24,pt.rx,true);
v.setFloat64(off+32,pt.ry,true);
v.setFloat64(off+40,pt.rz,true);
});
});

return buf;
},

getStructure(u){
let blocks=[];
for(let i=0;i<u.length-15;i++){
let ok=true;
for(let j=0;j<this.MARKER.length;j++){
if(u[i+j]!==this.MARKER[j]){ok=false;break;}
}
if(ok){
let id="";
let k=i+8;
while(u[k]!==93 && k<i+15){
id+=String.fromCharCode(u[k]);
k++;
}
blocks.push({id:parseInt(id),dataStart:k+1});
}
}
return blocks;
}
};

let original=null;
let data=null;

const fileInput=document.getElementById("fileInput");
const saveBtn=document.getElementById("saveBtn");
const editor=document.getElementById("editor");

fileInput.addEventListener("change",async e=>{
const f=e.target.files[0];
if(!f)return;
original=await f.arrayBuffer();
data=NuncioEngine.decode(original);
render();
saveBtn.disabled=false;
});

function render(){
editor.innerHTML="";
data.sources.forEach(s=>{
const div=document.createElement("div");
div.className="block";
div.innerHTML="<h3>Source "+s.id+"</h3>";

s.points.forEach((pt,i)=>{
div.innerHTML+=`
<input type="number" value="${pt.tx}" data-id="${s.id}" data-p="${i}" data-k="tx">
<input type="number" value="${pt.ty}" data-id="${s.id}" data-p="${i}" data-k="ty">
<input type="number" value="${pt.tz}" data-id="${s.id}" data-p="${i}" data-k="tz">
<input type="number" value="${pt.rx}" data-id="${s.id}" data-p="${i}" data-k="rx">
<input type="number" value="${pt.ry}" data-id="${s.id}" data-p="${i}" data-k="ry">
<input type="number" value="${pt.rz}" data-id="${s.id}" data-p="${i}" data-k="rz">
<br>`;
});
editor.appendChild(div);
});
}

editor.addEventListener("input",e=>{
const id=parseInt(e.target.dataset.id);
const p=parseInt(e.target.dataset.p);
const k=e.target.dataset.k;
const s=data.sources.find(x=>x.id===id);
s.points[p][k]=parseFloat(e.target.value);
});

saveBtn.addEventListener("click",()=>{
const newBuf=NuncioEngine.encode(original,data);
const blob=new Blob([newBuf],{type:"application/octet-stream"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="MODIFIED.MgComp";
a.click();
});

</script>

</body>
</html>