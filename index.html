<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>NUNCIO CORE - DIAGNOSTIC MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #00ff00; font-family: 'Courier New', monospace; }
        .terminal { background: #000; border: 1px solid #00ff00; height: 300px; overflow-y: auto; font-size: 12px; padding: 10px; }
        .data-card { background: #111; border-left: 4px solid #00ff00; margin-bottom: 20px; }
        input[type="number"] { background: #000; color: #fff; border: 1px solid #333; width: 100%; padding: 2px; }
    </style>
</head>
<body class="p-6">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1">
            <h1 class="text-2xl font-bold mb-4">NUNCIO_CORE_v4.2</h1>
            
            <div class="border-2 border-dashed border-green-900 p-8 text-center rounded-lg hover:bg-green-900/10 cursor-pointer mb-4" id="dropZone">
                <input type="file" id="fileInput" class="hidden">
                <p>CARGAR .MgComp</p>
                <p class="text-xs text-green-700 mt-2">PINCHA O ARRASTRA</p>
            </div>

            <button id="saveBtn" class="hidden w-full bg-green-600 text-black font-bold py-4 rounded hover:bg-green-400" onclick="exportFile()">
                GUARDAR CAMBIOS
            </button>
        </div>

        <div class="lg:col-span-2">
            <h3 class="text-xs uppercase text-green-800 mb-2">System Telemetry</h3>
            <div id="terminal" class="terminal mb-4">
                [SYSTEM] Ready. Awaiting file input...
            </div>
        </div>
    </div>

    <div id="editorArea" class="mt-8"></div>

    <script>
        const terminal = document.getElementById('terminal');
        const editor = document.getElementById('editorArea');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const saveBtn = document.getElementById('saveBtn');

        let originalArrayBuffer = null;
        let mainView = null;

        function log(msg, color = "#00ff00") {
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            terminal.appendChild(entry);
            terminal.scrollTop = terminal.scrollHeight;
        }

        dropZone.onclick = () => fileInput.click();

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        };

        async function handleFile(file) {
            log(`FILE_DETECTED: ${file.name}`);
            log(`SIZE: ${file.size} bytes`);
            
            try {
                log("STARTING_BINARY_READ...");
                const buffer = await file.arrayBuffer();
                originalArrayBuffer = new Uint8Array(buffer);
                mainView = new DataView(buffer);
                log("ARRAY_BUFFER_LOADED_SUCCESSFULLY", "#fff");

                log("SCANNING_FOR_STRUCTURE_TAGS...");
                const decoder = new TextDecoder();
                const text = decoder.decode(originalArrayBuffer);
                
                const regex = /\/g;
                let blocks = [];
                let match;
                
                while ((match = regex.exec(text)) !== null) {
                    blocks.push({
                        id: match[1],
                        start: match.index,
                        dataStart: match.index + match[0].length + 2
                    });
                    log(`FOUND_TAG: }] at offset ${match.index}`);
                }

                if (blocks.length === 0) {
                    throw new Error("No '' tags found in file. Format error.");
                }

                log(`TOTAL_BLOCKS_DETECTED: ${blocks.length}`, "#fff");
                renderBlocks(blocks);

            } catch (err) {
                log(`CRITICAL_ERROR: ${err.message}`, "#ff0000");
                console.error(err);
            }
        }

        function renderBlocks(blocks) {
            log("INITIATING_UI_RENDER...");
            let html = "";

            blocks.forEach((block, i) => {
                const nextStart = blocks[i+1] ? blocks[i+1].start : originalArrayBuffer.length;
                const byteRange = nextStart - block.dataStart;
                const points = block.id < 13 ? Math.floor(byteRange / 48) : 0;

                log(`RENDERING_SOURCE_${block.id}: ${points} points identified`);

                html += `
                <div class="data-card p-4 mb-6">
                    <div class="text-lg font-bold text-white mb-2 underline">SOURCE_${block.id}</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead>
                                <tr class="text-green-700">
                                    <th>#</th><th>TX</th><th>TY</th><th>TZ</th><th>RX</th><th>RY</th><th>RZ</th>
                                </tr>
                            </thead>
                            <tbody>`;

                if (points > 0) {
                    const renderLimit = Math.min(points, 200); // LÃ­mite para evitar cuelgues de RAM
                    for (let p = 0; p < renderLimit; p++) {
                        const offset = block.dataStart + (p * 48);
                        html += `<tr class="border-b border-green-900/30 hover:bg-green-900/10">
                            <td class="text-green-900">${p}</td>`;
                        for (let c = 0; c < 6; c++) {
                            const val = mainView.getFloat64(offset + (c * 8), true);
                            html += `<td class="p-1"><input type="number" step="any" data-off="${offset + (c * 8)}" value="${val}"></td>`;
                        }
                        html += `</tr>`;
                    }
                    if (points > 200) log(`NOTICE: Source ${block.id} truncated to 200 for performance`, "#ffa500");
                } else {
                    log(`CONFIG_BLOCK_${block.id}: Extracting parameters...`);
                    html += `<tr><td colspan="7" class="p-4">`;
                    for(let c=0; c<6; c++) {
                        const offset = block.dataStart + (c * 8);
                        if(offset + 8 <= nextStart) {
                            const val = mainView.getFloat64(offset, true);
                            html += `<div class="inline-block mr-4">P${c}: <input type="number" step="any" data-off="${offset}" value="${val}" class="w-32"></div>`;
                        }
                    }
                    html += `</td></tr>`;
                }

                html += `</tbody></table></div></div>`;
            });

            editor.innerHTML = html;
            saveBtn.classList.remove('hidden');
            log("UI_RENDER_COMPLETE. System stable.", "#fff");
        }

        function exportFile() {
            log("PREPARING_EXPORT...");
            const inputs = document.querySelectorAll('input[data-off]');
            inputs.forEach(inp => {
                const off = parseInt(inp.dataset.off);
                const val = parseFloat(inp.value);
                mainView.setFloat64(off, val, true);
            });

            const blob = new Blob([mainView.buffer], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "MASTER_REV4.MgComp";
            a.click();
            log("EXPORT_FINISHED. File downloaded.", "#fff");
        }
    </script>
</body>
</html>
