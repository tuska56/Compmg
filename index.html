<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>NUNCIO MG-COMP FULL EDITOR</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .box { border: 1px solid #0f0; padding: 20px; margin-bottom: 20px; }
        #fileInput { background: #0f0; color: #000; padding: 10px; cursor: pointer; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #333; padding: 5px; text-align: right; font-size: 12px; }
        th { background: #111; color: #0f0; }
        input { background: #000; color: #fff; border: 1px solid #0f0; width: 70px; }
        .btn-save { position: fixed; top: 20px; right: 20px; padding: 15px; background: #0f0; color: #000; font-weight: bold; cursor: pointer; border: none; }
        .source-title { color: #fff; background: #222; padding: 5px; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>NUNCIO_CORE_READER_v3</h1>
    
    <div class="box">
        <h3>1. SELECCIONA EL ARCHIVO .MgComp</h3>
        <input type="file" id="fileInput">
    </div>

    <button class="btn-save" onclick="save()">DESCARGAR EDITADO</button>

    <div id="output"></div>

<script>
    let rawBuffer = null;
    let dataView = null;

    // EL DISPARADOR: Este evento NO falla
    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            rawBuffer = new Uint8Array(event.target.result);
            dataView = new DataView(rawBuffer.buffer);
            renderFull();
        };
        reader.readAsArrayBuffer(file);
    };

    function renderFull() {
        const out = document.getElementById('output');
        out.innerHTML = "Generando tablas...";
        let html = "";

        const decoder = new TextDecoder();
        const text = decoder.decode(rawBuffer);
        
        // Buscamos todos los bloques 
        const regex = /\/g;
        let matches = [];
        let m;
        while ((m = regex.exec(text)) !== null) {
            matches.push({ id: m[1], start: m.index, dataStart: m.index + m[0].length + 2 });
        }

        matches.forEach((block, i) => {
            let end = (matches[i+1]) ? matches[i+1].start : rawBuffer.length;
            let size = end - block.dataStart;
            let points = (block.id < 13) ? Math.floor(size / 48) : 0;

            html += `<div class="source-title">BLOQUE ${block.id} (${points} Puntos)</div>`;
            html += `<table><tr><th>ID</th><th>TX</th><th>TY</th><th>TZ</th><th>RX</th><th>RY</th><th>RZ</th></tr>`;
            
            if (points > 0) {
                // Solo mostramos los puntos de los ejes
                for (let p = 0; p < points; p++) {
                    let off = block.dataStart + (p * 48);
                    html += `<tr><td>${p}</td>`;
                    for (let c = 0; c < 6; c++) {
                        let val = dataView.getFloat64(off + (c * 8), true);
                        html += `<td><input type="number" step="any" value="${val}" data-off="${off + (c * 8)}"></td>`;
                    }
                    html += `</tr>`;
                }
            } else {
                // Para Source 13: mostramos los primeros 6 valores de configuraci√≥n
                html += `<tr><td>META</td>`;
                for (let c = 0; c < 6; c++) {
                    let off = block.dataStart + (c * 8);
                    if (off + 8 <= end) {
                        let val = dataView.getFloat64(off, true);
                        html += `<td><input type="number" step="any" value="${val}" data-off="${off}"></td>`;
                    }
                }
                html += `</tr>`;
            }
            html += `</table>`;
        });

        out.innerHTML = html;
    }

    function save() {
        const inputs = document.querySelectorAll('input[data-off]');
        inputs.forEach(input => {
            let off = parseInt(input.dataset.off);
            let val = parseFloat(input.value);
            dataView.setFloat64(off, val, true);
        });

        const blob = new Blob([rawBuffer], {type: "application/octet-stream"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "EDITADO.MgComp";
        a.click();
    }
</script>
</body>
</html>
