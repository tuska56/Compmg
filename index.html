<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>NUNCIO MG-COMP MASTER EDITOR</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        #dropZone { 
            border: 3px dashed #444; padding: 50px; text-align: center; cursor: pointer; 
            transition: 0.3s; margin-bottom: 20px; border-radius: 10px;
        }
        #dropZone:hover { border-color: #00ff00; background: #252525; }
        #dropZone.active { border-color: #00ff00; background: #252525; }
        .axis-box { background: #2d2d2d; margin-bottom: 15px; border-radius: 5px; overflow: hidden; }
        .axis-title { background: #3d3d3d; padding: 10px; color: #00ff00; font-weight: bold; }
        .scroll-area { max-height: 300px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #111; padding: 8px; border: 1px solid #444; position: sticky; top: 0; }
        td { border: 1px solid #444; padding: 4px; }
        input { background: #000; color: #00ff00; border: 1px solid #555; width: 70px; font-size: 11px; }
        .save-bar { position: fixed; bottom: 20px; right: 20px; }
        .btn { background: #00ff00; color: #000; padding: 15px 30px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        #status { color: #888; margin-bottom: 10px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <h1>NUNCIO MG-COMP EDITOR <span style="font-size: 12px; color: #666;">v2.0</span></h1>
    <div id="status">ESTADO: ESPERANDO ARCHIVO...</div>

    <div id="dropZone">
        <strong>ARRASTRA AQUÍ TU ARCHIVO .MgComp</strong><br>
        o haz clic para buscarlo en tu PC
        <input type="file" id="fileInput" style="display:none">
    </div>

    <div id="editorArea"></div>
</div>

<div class="save-bar">
    <button class="btn" onclick="downloadBinary()">GUARDAR CAMBIOS (.MgComp)</button>
</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    const editorArea = document.getElementById('editorArea');

    let originalBuffer = null;
    let dataView = null;
    let blocks = [];

    // --- GESTIÓN DE EVENTOS DE CARGA ---
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('active');
    });

    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });

    async function handleFile(file) {
        status.innerText = "ESTADO: LEYENDO BINARIO...";
        const arrayBuffer = await file.arrayBuffer();
        originalBuffer = new Uint8Array(arrayBuffer);
        dataView = new DataView(arrayBuffer);
        
        parseFile();
        renderUI();
        
        dropZone.style.display = "none";
        status.innerText = `ESTADO: ARCHIVO "${file.name}" CARGADO Y DESCIFRADO.`;
        status.style.color = "#00ff00";
    }

    // --- LÓGICA DE DESCIFRADO COMPLETO ---
    function parseFile() {
        blocks = [];
        const decoder = new TextDecoder();
        const fullContent = decoder.decode(originalBuffer);
        
        const regex = /\/g;
        let match;
        
        while ((match = regex.exec(fullContent)) !== null) {
            blocks.push({
                id: parseInt(match[1]),
                start: match.index,
                dataStart: match.index + match[0].length + 2 // Offset tras el tag
            });
        }

        // Calcular limites y puntos
        for (let i = 0; i < blocks.length; i++) {
            let end = (i < blocks.length - 1) ? blocks[i+1].start : originalBuffer.length;
            blocks[i].end = end;
            let size = end - blocks[i].dataStart;
            // Si es un eje (source < 13), cada punto son 48 bytes (6 doubles)
            blocks[i].points = blocks[i].id < 13 ? Math.floor(size / 48) : 0;
        }
    }

    function renderUI() {
        editorArea.innerHTML = "";
        blocks.forEach(b => {
            const div = document.createElement('div');
            div.className = 'axis-box';
            let content = `<div class="axis-title">BLOQUE [SOURCE ${b.id}] - ${b.points > 0 ? b.points + ' Puntos Detectados' : 'Configuración'}</div>`;
            
            if (b.points > 0) {
                content += `<div class="scroll-area"><table><tr><th>ID</th><th>TX</th><th>TY</th><th>TZ</th><th>RX</th><th>RY</th><th>RZ</th></tr>`;
                for (let p = 0; p < b.points; p++) {
                    let offset = b.dataStart + (p * 48);
                    content += `<tr><td>${p}</td>`;
                    for (let c = 0; c < 6; c++) {
                        let val = dataView.getFloat64(offset + (c * 8), true);
                        content += `<td><input type="number" step="any" data-off="${offset + (c * 8)}" value="${val.toFixed(6)}"></td>`;
                    }
                    content += `</tr>`;
                }
                content += `</table></div>`;
            } else {
                // Para Source 13 u otros metadatos (lectura directa de los primeros 6 doubles)
                content += `<div style="padding:10px;">`;
                for (let c = 0; c < 6; c++) {
                    let offset = b.dataStart + (c * 8);
                    if (offset + 8 <= b.end) {
                        let val = dataView.getFloat64(offset, true);
                        content += ` Parámetro ${c}: <input type="number" step="any" data-off="${offset}" value="${val.toFixed(6)}"> `;
                    }
                }
                content += `</div>`;
            }
            div.innerHTML = content;
            editorArea.appendChild(div);
        });
    }

    function downloadBinary() {
        const inputs = document.querySelectorAll('input[data-off]');
        inputs.forEach(input => {
            const offset = parseInt(input.dataset.off);
            const value = parseFloat(input.value);
            dataView.setFloat64(offset, value, true);
        });

        const blob = new Blob([dataView.buffer], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "EDITADO_MAESTRO.MgComp";
        a.click();
        status.innerText = "ESTADO: ARCHIVO EXPORTADO CORRECTAMENTE.";
    }
</script>

</body>
</html>
