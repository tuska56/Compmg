<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nuncio MgComp Editor Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; color: #333; margin: 20px; }
        .container { max-width: 900px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: auto; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .section { margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #3498db; color: white; }
        input[type="number"] { width: 80px; padding: 5px; border: 1px solid #3498db; border-radius: 3px; }
        .btn { background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #219150; }
        .log { background: #222; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; height: 100px; overflow-y: scroll; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Nuncio MgComp Editor <small style="font-size: 0.5em;">v1.0 GitHub Edition</small></h1>
    
    <div class="section">
        <h3>1. Cargar Fichero Original</h3>
        <input type="file" id="fileInput" accept=".MgComp">
    </div>

    <div id="editorZone" style="display:none;">
        <div class="section">
            <h3>2. Constantes de Geometría (Source 13)</h3>
            <label>Squareness XY: </label><input type="number" id="sqXY" step="0.001">
            <label> YZ: </label><input type="number" id="sqYZ" step="0.001">
            <label> ZX: </label><input type="number" id="sqZX" step="0.001">
        </div>

        <div class="section">
            <h3>3. Puntos de Compensación Eje X (Source 1)</h3>
            <table id="puntosX">
                <thead>
                    <tr>
                        <th>Punto</th>
                        <th>TX (Error Pos.)</th>
                        <th>TY (Rectitud)</th>
                        <th>TZ (Rectitud)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <button class="btn" onclick="saveFile()">Descargar Fichero Compatible</button>
    </div>

    <h3>Consola de Sistema</h3>
    <div id="console" class="log">Esperando archivo...</div>
</div>

<script>
    let binaryData = null;
    let offsets = { s1: -1, s13: -1 };

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            binaryData = new Uint8Array(e.target.result);
            log("Archivo cargado: " + binaryData.byteLength + " bytes.");
            scanStructure();
            loadValues();
            document.getElementById('editorZone').style.display = 'block';
        };
        reader.readAsArrayBuffer(file);
    });

    function log(msg) {
        const c = document.getElementById('console');
        c.innerHTML += "> " + msg + "<br>";
        c.scrollTop = c.scrollHeight;
    }

    function scanStructure() {
        const decoder = new TextDecoder();
        const text = decoder.decode(binaryData.slice(0, 100000)); // Escaneo inicial
        
        const pos1 = text.indexOf("");
        const pos13 = text.indexOf("");
        
        offsets.s1 = pos1 !== -1 ? pos1 : -1;
        offsets.s13 = pos13 !== -1 ? pos13 : -1;
        log("Estructura mapeada. Source 1: " + offsets.s1 + " | Source 13: " + offsets.s13);
    }

    function loadValues() {
        const view = new DataView(binaryData.buffer);
        
        // Cargar Squareness (Double 64-bit Little Endian)
        if(offsets.s13 !== -1) {
            document.getElementById('sqXY').value = view.getFloat64(offsets.s13 + 20, true).toFixed(4);
            document.getElementById('sqYZ').value = view.getFloat64(offsets.s13 + 28, true).toFixed(4);
            document.getElementById('sqZX').value = view.getFloat64(offsets.s13 + 36, true).toFixed(4);
        }

        // Cargar primeros 5 puntos del Eje X
        const tbody = document.querySelector("#puntosX tbody");
        tbody.innerHTML = "";
        if(offsets.s1 !== -1) {
            for(let i=0; i<5; i++) {
                let base = offsets.s1 + 50 + (i * 48);
                let tx = view.getFloat64(base, true).toFixed(4);
                let ty = view.getFloat64(base + 8, true).toFixed(4);
                let tz = view.getFloat64(base + 16, true).toFixed(4);
                
                tbody.innerHTML += `<tr>
                    <td>Punto ${i}</td>
                    <td><input type="number" value="${tx}" id="tx_${i}" step="0.0001"></td>
                    <td><input type="number" value="${ty}" id="ty_${i}" step="0.0001"></td>
                    <td><input type="number" value="${tz}" id="tz_${i}" step="0.0001"></td>
                </tr>`;
            }
        }
    }

    function saveFile() {
        const view = new DataView(binaryData.buffer);
        
        // Guardar Squareness
        view.setFloat64(offsets.s13 + 20, parseFloat(document.getElementById('sqXY').value), true);
        view.setFloat64(offsets.s13 + 28, parseFloat(document.getElementById('sqYZ').value), true);
        view.setFloat64(offsets.s13 + 36, parseFloat(document.getElementById('sqZX').value), true);

        // Guardar Puntos X
        for(let i=0; i<5; i++) {
            let base = offsets.s1 + 50 + (i * 48);
            view.setFloat64(base, parseFloat(document.getElementById('tx_'+i).value), true);
            view.setFloat64(base + 8, parseFloat(document.getElementById('ty_'+i).value), true);
            view.setFloat64(base + 16, parseFloat(document.getElementById('tz_'+i).value), true);
        }

        const blob = new Blob([binaryData], {type: "application/octet-stream"});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "MODIFICADO.MgComp";
        a.click();
        log("Fichero generado correctamente.");
    }
</script>

</body>
</html>