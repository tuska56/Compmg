<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>NUNCIO VISOR TOTAL</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #000; color: #0f0; padding: 20px; }
        .log { border: 1px solid #333; padding: 10px; margin-bottom: 20px; color: #888; font-size: 12px; height: 100px; overflow-y: scroll; }
        .axis-section { border: 1px solid #0f0; margin-bottom: 30px; background: #050505; }
        .axis-header { background: #0f0; color: #000; padding: 5px 10px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #222; padding: 4px; text-align: right; font-size: 12px; }
        th { color: #0f0; background: #111; position: sticky; top: 0; }
        .loading { color: yellow; font-weight: bold; }
    </style>
</head>
<body>

    <h2>NUNCIO_GEOMETRIC_VISOR_v1.0</h2>
    
    <div id="statusLog" class="log">SISTEMA INICIADO. Esperando archivo...</div>

    <input type="file" id="fileInput" style="padding: 20px; border: 2px dashed #0f0; width: 100%; cursor: pointer;">

    <div id="outputArea"></div>

<script>
    const fileInput = document.getElementById('fileInput');
    const logDiv = document.getElementById('statusLog');
    const output = document.getElementById('outputArea');

    function log(msg) {
        logDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        log(`Archivo seleccionado: ${file.name}`);
        output.innerHTML = "<p class='loading'>PROCESANDO MATRIZ COMPLETA...</p>";

        const reader = new FileReader();
        reader.onload = function(event) {
            const buffer = new Uint8Array(event.target.result);
            const view = new DataView(buffer.buffer);
            log("Fichero en memoria. Escaneando estructura binaria...");
            
            // 1. Localizar los bloques de forma rápida
            const bloques = [];
            const marker = [91, 115, 111, 117, 114, 99, 101, 58]; // "!== marker[j]) { match = false; break; }
                }
                if (match) {
                    let idStr = "";
                    let k = i + 8;
                    while (buffer[k] !== 93 && k < i + 15) { // 93 es "]"
                        idStr += String.fromCharCode(buffer[k]);
                        k++;
                    }
                    bloques.push({ id: parseInt(idStr), start: i, dataStart: k + 1 });
                    log(`Detectado BLOQUE ${idStr} en offset ${i}`);
                }
            }

            // 2. Renderizar TODO
            renderizarTodo(bloques, view, buffer.length);
        };
        reader.readAsArrayBuffer(file);
    };

    function renderizarTodo(bloques, view, totalSize) {
        let html = "";

        bloques.forEach((b, idx) => {
            const end = (bloques[idx + 1]) ? bloques[idx + 1].start : totalSize;
            const size = end - b.dataStart;
            const pts = (b.id < 13) ? Math.floor(size / 48) : 0;

            html += `<div class="axis-section">
                        <div class="axis-header">EJE / FUENTE: ${b.id} | PUNTOS TOTALES: ${pts}</div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead>
                                    <tr><th>#</th><th>TX</th><th>TY</th><th>TZ</th><th>RX</th><th>RY</th><th>RZ</th></tr>
                                </thead>
                                <tbody>`;

            if (pts > 0) {
                for (let p = 0; p < pts; p++) {
                    const off = b.dataStart + (p * 48);
                    html += `<tr><td>${p}</td>`;
                    for (let c = 0; c < 6; c++) {
                        try {
                            const val = view.getFloat64(off + (c * 8), true);
                            html += `<td>${val.toFixed(6)}</td>`;
                        } catch(e) {
                            html += `<td>ERR</td>`;
                        }
                    }
                    html += `</tr>`;
                }
            } else {
                // Para bloques de configuración (como el 13)
                html += `<tr><td>CONFIG</td>`;
                for (let c = 0; c < 6; c++) {
                    const off = b.dataStart + (c * 8);
                    if (off + 8 <= end) {
                        const val = view.getFloat64(off, true);
                        html += `<td>${val.toFixed(6)}</td>`;
                    }
                }
                html += `</tr>`;
            }

            html += `</tbody></table></div></div>`;
        });

        output.innerHTML = html;
        log("RENDERIZADO COMPLETO. Todos los datos visibles.");
    }
</script>
</body>
</html>
