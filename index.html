<!DOCTYPE html>
<html>
<head>
    <title>RETO: CARGA TOTAL</title>
</head>
<body>
    <h2>1. Selecciona el fichero .MgComp</h2>
    <input type="file" id="f" onchange="leer(this)">
    
    <div id="status" style="color: blue; font-family: monospace; margin: 20px 0;"></div>
    
    <button id="btnSave" style="display:none; padding: 10px; background: green; color: white;" onclick="guardar()">DESCARGAR EDITADO</button>

    <div id="tablas"></div>

<script>
    let buffer;
    let vista;

    function leer(input) {
        const p = document.getElementById('status');
        const file = input.files[0];
        if (!file) return;

        p.innerText = "Leyendo: " + file.name + "...";
        
        const r = new FileReader();
        r.onload = function(e) {
            buffer = new Uint8Array(e.target.result);
            vista = new DataView(buffer.buffer);
            p.innerText = "Cargado. Buscando datos...";
            
            procesar();
        };
        r.readAsArrayBuffer(file);
    }

    function procesar() {
        const out = document.getElementById('tablas');
        const text = new TextDecoder().decode(buffer);
        const regex = /\/g;
        let bloques = [];
        let m;

        while ((m = regex.exec(text)) !== null) {
            bloques.push({id: m[1], inicio: m.index, datos: m.index + m[0].length + 2});
        }

        if (bloques.length === 0) {
            document.getElementById('status').innerText = "ERROR: No se encontraron marcas [source].";
            return;
        }

        let html = "";
        bloques.forEach((b, i) => {
            let fin = (bloques[i+1]) ? bloques[i+1].inicio : buffer.length;
            let pts = (b.id < 13) ? Math.floor((fin - b.datos) / 48) : 0;
            
            html += "<h3>BLOQUE " + b.id + "</h3><table border='1'>";
            
            if (pts > 0) {
                // Limitamos a 100 puntos para que la web no se cuelgue al pintar
                for (let j = 0; j < Math.min(pts, 100); j++) {
                    let off = b.datos + (j * 48);
                    html += "<tr><td>P" + j + "</td>";
                    for (let c = 0; c < 6; c++) {
                        let v = vista.getFloat64(off + (c * 8), true);
                        html += "<td><input type='number' step='any' data-off='" + (off + (c * 8)) + "' value='" + v + "'></td>";
                    }
                    html += "</tr>";
                }
            } else {
                html += "<tr>";
                for (let c = 0; c < 6; c++) {
                    let off = b.datos + (c * 8);
                    if (off + 8 <= fin) {
                        let v = vista.getFloat64(off, true);
                        html += "<td><input type='number' step='any' data-off='" + off + "' value='" + v + "'></td>";
                    }
                }
                html += "</tr>";
            }
            html += "</table>";
        });

        out.innerHTML = html;
        document.getElementById('btnSave').style.display = "block";
        document.getElementById('status').innerText = "LISTO. Se muestran los primeros puntos de cada eje.";
    }

    function guardar() {
        const inputs = document.querySelectorAll('input[data-off]');
        inputs.forEach(i => {
            vista.setFloat64(parseInt(i.dataset.off), parseFloat(i.value), true);
        });
        const blob = new Blob([buffer], {type: "application/octet-stream"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "nuevo_maestro.MgComp";
        a.click();
    }
</script>
</body>
</html>
